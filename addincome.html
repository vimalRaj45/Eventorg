<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Referral Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    :root {
      --primary-color: #4e73df;
      --secondary-color: #f8f9fc;
      --accent-color: #2e59d9;
      --text-color: #5a5c69;
    }
    
    body {
      font-family: 'Outfit', sans-serif;
      background-color: #f8f9fc;
      color: var(--text-color);
    }
    
    .container {
      max-width: 100%;
      padding: 20px;
    }
    
    .table-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      padding: 20px;
      margin-top: 20px;
    }
    
    .header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    .btn-primary:hover {
      background-color: var(--accent-color);
      border-color: var(--accent-color);
    }
    
    .table thead {
      background-color: var(--primary-color);
      color: white;
    }
    
    .table th {
      font-weight: 600;
    }
    
    .action-buttons .btn {
      margin: 2px 0;
      width: 80px;
      font-size: 0.8rem;
    }
    
    .modal-content {
      border-radius: 10px;
    }
    
    .modal-header {
      background-color: var(--primary-color);
      color: white;
      border-radius: 10px 10px 0 0;
    }
    
    .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
    }
    
    .profile-img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border: 2px solid #e3e6f0;
    }
    
    .detail-view-img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border: 3px solid #e3e6f0;
      margin: 0 auto;
      display: block;
    }
    
    @media (max-width: 768px) {
      .table-responsive {
        overflow-x: auto;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="d-flex justify-content-between align-items-center">
        <h1 class="mb-0"><i class="bi bi-people-fill me-2"></i>Referral Dashboard</h1>
        <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#referralModal">
          <i class="bi bi-plus-circle me-1"></i> Add New Referral
        </button>
      </div>
    </div>

    <div class="table-container">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Email</th>
              <th>Participants</th>
              <th>Reward (₹)</th>
              <th>Payment</th>
              <th>Downline</th>
              <th>Contact</th>
              <th>Profile</th>
              <th class="action-buttons">Actions</th>
            </tr>
          </thead>
          <tbody id="referralTableBody" class="table-group-divider"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div class="modal fade" id="referralModal" tabindex="-1" aria-labelledby="referralModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <form id="referralForm">
          <div class="modal-header">
            <h5 class="modal-title" id="referralModalLabel">Referral Details</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <input type="hidden" id="referralId">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Student Name*</label>
                <input type="text" class="form-control" id="stud_name" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Email*</label>
                <input type="email" class="form-control" id="email" required>
              </div>
              
              <div class="col-md-6">
                <label class="form-label">Phone Number</label>
                <input type="tel" class="form-control" id="ph_no" placeholder="+91XXXXXXXXXX">
              </div>
              <div class="col-md-6">
                <label class="form-label">Profile Picture URL</label>
                <input type="url" class="form-control" id="profile_picture_url" placeholder="https://example.com/image.jpg">
              </div>
              
              <div class="col-md-4">
                <label class="form-label">Total Participants</label>
                <input type="number" class="form-control" id="total_participants">
              </div>
              <div class="col-md-4">
                <label class="form-label">Current Participants</label>
                <input type="number" class="form-control" id="current_participants">
              </div>
              <div class="col-md-4">
                <label class="form-label">Reward Amount (₹)</label>
                <input type="text" class="form-control" id="reward_amount_inr">
              </div>
              
              <div class="col-md-6">
                <label class="form-label">Payment Date</label>
                <input type="date" class="form-control" id="payment_date">
              </div>
              <div class="col-md-6">
                <label class="form-label">Transaction ID</label>
                <input type="text" class="form-control" id="transaction_id">
              </div>
              
              <div class="col-md-6">
                <label class="form-label">Downline Name</label>
                <input type="text" class="form-control" id="downline_name">
              </div>
              <div class="col-md-6">
                <label class="form-label">Total Downline Participants</label>
                <input type="number" class="form-control" id="total_downline_participants">
              </div>
              
              <div class="col-md-4">
                <label class="form-label">Total Invitations</label>
                <input type="number" class="form-control" id="total_invitations">
              </div>
              <div class="col-md-4">
                <label class="form-label">Inter Total</label>
                <input type="number" class="form-control" id="inter_total">
              </div>
              <div class="col-md-4">
                <label class="form-label">Role</label>
                <input type="text" class="form-control" id="role">
              </div>
              
              <div class="col-12">
                <label class="form-label">Message</label>
                <textarea class="form-control" id="msg" rows="2"></textarea>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Referral</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- View Details Modal -->
  <div class="modal fade" id="viewReferralModal" tabindex="-1" aria-labelledby="viewReferralModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewReferralModalLabel">Referral Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="referralDetailsContent">
          <!-- Content will be inserted here by JavaScript -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const api = "https://eventdb.onrender.com/referrals";

    const fetchData = async () => {
      try {
        const res = await fetch(api);
        const data = await res.json();
        const tbody = document.getElementById("referralTableBody");
        tbody.innerHTML = "";

        data.forEach((r, index) => {
          tbody.innerHTML += `
            <tr>
              <td>${index + 1}</td>
              <td><strong>${r.stud_name}</strong></td>
              <td>${r.email}</td>
              <td>
                <span class="badge bg-primary">${r.total_participants || 0}</span>
                ${r.downline_participants ? `<span class="badge bg-secondary ms-1">${r.total_downline_participants} down</span>` : ''}
              </td>
              <td>${r.reward_amount_inr ? '₹' + r.reward_amount_inr : '-'}</td>
              <td>
                ${r.payment_date ? `<small>${r.payment_date.split('T')[0]}</small>` : ''}
                ${r.transaction_id ? `<br><small class="text-muted">${r.transaction_id.substring(0, 8)}...</small>` : ''}
              </td>
              <td>${r.downline_name || '-'}</td>
              <td>${r.ph_no || '-'}</td>
              <td>
                ${r.profile_picture_url ? 
                  `<img src="${r.profile_picture_url}" class="profile-img rounded-circle" alt="${r.stud_name}">` : 
                  '<i class="bi bi-person-circle fs-4 text-muted"></i>'}
              </td>
              <td class="action-buttons">
                <button class="btn btn-sm btn-info mb-1" onclick='viewReferral(${r.id})'>
                  <i class="bi bi-eye"></i> View
                </button>
                <button class="btn btn-sm btn-danger mb-1" onclick='deleteReferral(${r.id})'>
                  <i class="bi bi-trash"></i> Delete
                </button>
                ${r.ph_no ? `
                <a class="btn btn-sm btn-success mb-1" target="_blank"
                   href="https://wa.me/${r.ph_no}?text=${encodeURIComponent(`Hi ${r.stud_name}, your referral reward is ₹${r.reward_amount_inr}`)}">
                  <i class="bi bi-whatsapp"></i> WhatsApp
                </a>
                <a class="btn btn-sm btn-secondary" target="_blank"
                   href="sms:${r.ph_no}?body=${encodeURIComponent(`Hi ${r.stud_name}, your referral reward is ₹${r.reward_amount_inr}`)}">
                  <i class="bi bi-chat-text"></i> SMS
                </a>
                ` : '<button class="btn btn-sm btn-secondary disabled mb-1">No Phone</button>'}
              </td>
            </tr>
          `;
        });
      } catch (err) {
        console.error("Error loading data:", err);
        alert("Failed to load data. Please check console for details.");
      }
    };

    const viewReferral = async (id) => {
      try {
        const res = await fetch(`${api}/${id}`);
        const referral = await res.json();
        
        const content = `
          <div class="row">
            <div class="col-md-12 text-center mb-3">
              ${referral.profile_picture_url ? 
                `<img src="${referral.profile_picture_url}" class="detail-view-img rounded-circle mb-2" alt="${referral.stud_name}">` : 
                '<i class="bi bi-person-circle fs-1 text-muted"></i>'}
              <h3>${referral.stud_name}</h3>
              <p class="text-muted">${referral.email}</p>
            </div>
            
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                  <i class="bi bi-person-lines-fill"></i> Basic Information
                </div>
                <div class="card-body">
                  <p><strong>Phone:</strong> ${referral.ph_no || 'Not provided'}</p>
                  <p><strong>Role:</strong> ${referral.role || 'Not specified'}</p>
                  <p><strong>Message:</strong> ${referral.msg || 'None'}</p>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header bg-success text-white">
                  <i class="bi bi-graph-up"></i> Participation Stats
                </div>
                <div class="card-body">
                  <p><strong>Total Participants:</strong> ${referral.total_participants || 0}</p>
                  <p><strong>Current Participants:</strong> ${referral.current_participants || 0}</p>
                  <p><strong>Total Invitations:</strong> ${referral.total_invitations || 0}</p>
                  <p><strong>Inter Total:</strong> ${referral.inter_total || 0}</p>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header bg-info text-white">
                  <i class="bi bi-people-fill"></i> Downline Information
                </div>
                <div class="card-body">
                  <p><strong>Downline Name:</strong> ${referral.downline_name || 'None'}</p>
                  <p><strong>Total Downline Participants:</strong> ${referral.total_downline_participants || 0}</p>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header bg-warning text-dark">
                  <i class="bi bi-cash-stack"></i> Payment Information
                </div>
                <div class="card-body">
                  <p><strong>Reward Amount:</strong> ${referral.reward_amount_inr ? '₹' + referral.reward_amount_inr : 'Not specified'}</p>
                  <p><strong>Payment Date:</strong> ${referral.payment_date ? referral.payment_date.split('T')[0] : 'Not paid'}</p>
                  <p><strong>Transaction ID:</strong> ${referral.transaction_id || 'Not available'}</p>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.getElementById('referralDetailsContent').innerHTML = content;
        const viewModal = new bootstrap.Modal(document.getElementById('viewReferralModal'));
        viewModal.show();
      } catch (error) {
        console.error("Error viewing referral:", error);
        showToast('Failed to load referral details', 'danger');
      }
    };

    const deleteReferral = async (id) => {
      if (confirm("Are you sure you want to delete this referral?")) {
        try {
          await fetch(`${api}/${id}`, { method: "DELETE" });
          fetchData();
          showToast('Referral deleted successfully', 'success');
        } catch (error) {
          console.error("Error deleting referral:", error);
          showToast('Failed to delete referral', 'danger');
        }
      }
    };

    document.getElementById("referralForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {};
      document.querySelectorAll("#referralForm input, #referralForm textarea").forEach(input => {
        data[input.id] = input.value;
      });

      const isEdit = !!data.referralId;
      const method = isEdit ? "PUT" : "POST";
      const url = isEdit ? `${api}/${data.referralId}` : api;
      delete data.referralId;

      try {
        const response = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        if (!response.ok) throw new Error('Network response was not ok');

        bootstrap.Modal.getInstance(document.getElementById('referralModal')).hide();
        fetchData();
        e.target.reset();
        showToast(`Referral ${isEdit ? 'updated' : 'added'} successfully`, 'success');
      } catch (error) {
        console.error("Error saving referral:", error);
        showToast('Failed to save referral', 'danger');
      }
    });

    function showToast(message, type = 'success') {
      const toastContainer = document.createElement('div');
      toastContainer.innerHTML = `
        <div class="toast align-items-center text-white bg-${type} border-0 show" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">
              ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      `;
      toastContainer.style.position = 'fixed';
      toastContainer.style.top = '20px';
      toastContainer.style.right = '20px';
      toastContainer.style.zIndex = '9999';
      document.body.appendChild(toastContainer);
      
      setTimeout(() => {
        toastContainer.remove();
      }, 3000);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      fetchData();
    });
  </script>
</body>
</html>
