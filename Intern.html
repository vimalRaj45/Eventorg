<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Internship Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
   :root {
        --primary-color: #7b3f00;         /* Rich Brown (Primary) */
        --primary-dark: #4e2800;          /* Darker Rich Brown */
        --secondary-color: #f3e5d8;       /* Light Beige (Soft Background) */
        --success-color: #59c030;         /* Earthy Greenish Brown (Success) */
        --warning-color: #c97d30;         /* Amber-Brown (Warning) */
        --danger-color: #8b0000;          /* Dark Red-Brown (Danger) */
        --dark-color: #ed0b0b;            /* Very Dark Brown (Body Text) */
        --light-color: #f9f4f0;           /* Very Light Brown/Beige (BG) */
        --brownish-color: #5e0a00;        /* Deep Brownish Red */
    }

    /* Only override specific Bootstrap elements */
    .bg-primary {
        background-color: var(--primary-color) !important;
    }
    
    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-dark);
    }
    
    .btn-primary:hover {
        background-color: var(--primary-dark);
        border-color: var(--primary-dark);
    }
    
    .btn-outline-primary {
        color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .btn-outline-primary:hover {
        background-color: var(--primary-color);
        color: white;
    }
    
    .badge-active {
        background-color: var(--success-color);
    }
    
    .badge-inactive {
        background-color: var(--dark-color);
    }
    
    .badge-completed {
        background-color: var(--primary-color);
    }
    
    /* Navigation specific */
    #loginItem {
        background: var(--brownish-color) !important;
    }
    
    #logoutItem {
        background: var(--warning-color) !important;
    }
    
    /* Card header override */
    .card-header.bg-primary {
        background-color: var(--primary-color) !important;
    }
    
    /* Modal header override */
    .modal-header.bg-primary {
        background-color: var(--primary-color) !important;
    }
    
    /* Background and text colors */
    body {
        background-color: var(--light-color);
        color: var(--dark-color);
    }
    
    /* Payment instructions */
    .payment-instructions {
        background-color: var(--secondary-color);
    }
    
    /* Keep all other Bootstrap styles intact */
    .internship-card { 
        transition: all 0.2s; 
        cursor: pointer; 
    }
    
    .internship-card:hover { 
        transform: translateY(-5px); 
        box-shadow: 0 10px 20px rgba(0,0,0,0.1); 
    }
    
    .internship-img { 
        height: 180px; 
        object-fit: cover; 
    }
    
    .qr-img { 
        max-width: 200px; 
        max-height: 200px; 
    }
    
    .application-flow { 
        display: none; 
    }
    
    .active-flow { 
        display: block; 
    }
  </style>
</head>
<body class="bg-light">
 <!-- Add Bootstrap CSS in <head> if not already included -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Navigation -->
<nav style="
  position: fixed;
  top: 0;
  width: 100%;
  background: white;
  box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
  z-index: 9999;
  padding: 0 20px;
  height: 70px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-family: 'Outfit', sans-serif;
">


  <!-- Logo -->
  <div style="
    font-size: 1.8rem;
    font-weight: 700;
    color: #6366f1;
  "> <img src="https://i.ibb.co/spyHywtx/Event-Hub-Logo45-1.jpg" alt="Logo" style="height: 55px; margin-top: 2%;"></div>

  <!-- Hamburger -->
  <div id="hamburgerBtn" style="
    display: none;
    flex-direction: column;
    cursor: pointer;
  " onclick="toggleNavMenu()">
    <div style="width: 25px; height: 3px; background: #1f2937; margin: 3px 0;"></div>
    <div style="width: 25px; height: 3px; background: #1f2937; margin: 3px 0;"></div>
    <div style="width: 25px; height: 3px; background: #1f2937; margin: 3px 0;"></div>
  </div>

  <!-- Nav Menu -->
  <div id="navMenu" style="
    display: flex;
    gap: 2rem;
    list-style: none;
    align-items: center;
  ">
    <a href='/edwynahome' style='text-decoration: none; color: #1f2937; font-weight: 500;'>Home</a>
    <a href='/events' style='text-decoration: none; color: #1f2937; font-weight: 500;'>Events</a>
    <a href='/certificates' style='text-decoration: none; color: #1f2937; font-weight: 500;'>Certificates</a>
    <a href='/results' style='text-decoration: none; color: #1f2937; font-weight: 500;'>Results</a>
    <a href='/intern' style='text-decoration: none; color: #1f2937; font-weight: 650;'>Internships</a>
    <a href='/refer' style='text-decoration: none; color: #1f2937; font-weight: 500;'>Referral</a>
    <a href='/1' style='text-decoration: none; color: #1f2937; font-weight: 500;'>Profile</a>
    <a href='/help' style='text-decoration: none; color: #1f2937; font-weight: 500;'>Help</a>
    <!-- Login and Logout -->
    <a href='/login' id='loginItem' style='
      text-decoration: none;
      background: rgba(94,10,0,255);
      color: white;
      padding: 0.5rem 1.2rem;
      border-radius: 8px;
      font-weight: 600;
    '>Login</a>

    <a id="logoutItem" href="#" onclick="logoutUser()" style="
      text-decoration: none;
      background: #f46721;
      color: white;
      padding: 0.5rem 1.2rem;
      border-radius: 8px;
      font-weight: 600;
      display: none;
    ">Logout</a>
  </div>
  </div>
</nav>


<!-- Bootstrap JS bundle at end of body -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>






  <div class="container py-4 " style="margin-top: 10vh;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="fas fa-briefcase me-2"></i>Internship Opportunities</h2>
      <div>
        <button class="btn btn-outline-primary me-2" onclick="loadMyApplications()">
          <i class="fas fa-list-check"></i> My Applications
        </button>
      </div>
    </div>

    <!-- Available Internships -->
    <div class="card shadow mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Available Internships</h5>
      </div>
      <div class="card-body">
        <div class="row" id="internshipsList">
          <!-- Internships will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Application & Payment Modal -->
    <div class="modal fade" id="applicationModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="applicationModalTitle">Apply for Internship</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Application Confirmation Step -->
            <div id="confirmStep" class="application-flow active-flow">
              <p>Are you sure you want to apply for this internship?</p>
              <div class="d-flex justify-content-end mt-4">
                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmApplication()">Confirm Application</button>
              </div>
            </div>

            <!-- Payment Step -->
            <div id="paymentStep" class="application-flow">
              <div id="paymentContent">
                <!-- Payment content will be loaded here -->
              </div>
              <div class="d-flex justify-content-end mt-4">
                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitPayment()">Submit Payment</button>
              </div>
            </div>

            <!-- Success Step -->
            <div id="successStep" class="application-flow text-center py-4">
              <i class="fas fa-check-circle text-success mb-3" style="font-size: 3rem;"></i>
              <h4 id="successMessage">Application Submitted Successfully!</h4>
              <p class="text-muted">Your payment is being verified</p>
              <button type="button" class="btn btn-primary mt-3" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- My Applications Modal -->
    <div class="modal fade" id="applicationsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">My Applications</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="applicationsModalBody">
            <!-- Content loaded dynamically -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
       // ‚õî Disable right-click and certain dev tools
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', function(e) {
  if (
    e.key === 'F12' ||
    (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key.toUpperCase())) ||
    (e.ctrlKey && ['U', 'S', 'P'].includes(e.key.toUpperCase()))
  ) {
    e.preventDefault();
    showDevPopup();
  }
});

// üö´ Developer Tools Blocked Popup (SweetAlert2)
function showDevPopup() {
 console.warn('Developer tools are disabled for this page.');
}

    const BASE = "https://eventdb.onrender.com";
    const token = localStorage.getItem('jwtToken');
    let applicationsModal = null;
    let applicationModal = null;
    let currentInternshipId = null;
    let currentApplicationId = null;

    document.addEventListener('DOMContentLoaded', () => {
      applicationsModal = new bootstrap.Modal(document.getElementById('applicationsModal'));
      applicationModal = new bootstrap.Modal(document.getElementById('applicationModal'));
      
      if (!token) {
        Swal.fire('Error', 'You need to login first', 'error').then(() => {
          window.location.href = 'index.html';
        });
        return;
      }
      
      loadInternships();
    });

    function logout() {
      localStorage.removeItem('jwtToken');
      window.location.href = 'index.html';
    }

   async function loadInternships() {
  try {
    document.getElementById('internshipsList').innerHTML = `
      <div class="col-12 text-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p>Loading internships...</p>
      </div>
    `;
    
    // Fetch both internships and applications in parallel
    const [internshipsRes, applicationsRes] = await Promise.all([
      fetch(`${BASE}/api/internships`, { headers: { Authorization: `Bearer ${token}` } }),
      fetch(`${BASE}/api/internships/applied`, { headers: { Authorization: `Bearer ${token}` } })
    ]);
    
    if (!internshipsRes.ok) throw new Error('Failed to load internships');
    
    const internships = await internshipsRes.json();
    const applications = applicationsRes.ok ? await applicationsRes.json() : [];
    
    renderInternships(internships, applications);
  } catch (err) {
    document.getElementById('internshipsList').innerHTML = `
      <div class="col-12 text-center text-danger">
        Error loading internships: ${err.message}
      </div>
    `;
  }
}

function getStatusClass(status) {
  switch (status) {
    case 'active': return 'badge-active';
    case 'inactive': return 'badge-inactive';
    case 'completed': return 'badge-completed';
    default: return 'badge-secondary';
  }
}

   function renderInternships(internships, applications) {
  const container = document.getElementById('internshipsList');
  
  if (internships.length === 0) {
    container.innerHTML = `
      <div class="col-12 text-center text-muted">
        No internships available at this time
      </div>
    `;
    return;
  }
  
  container.innerHTML = internships.map(internship => {
    const hasApplied = applications.some(app => app.internship_id === internship.id);
    const isPaid = applications.some(app => app.internship_id === internship.id && app.transaction_id);
    
    return `
      <div class="col-md-6 mb-4">
        <div class="card h-100 internship-card">
          ${internship.imgurl ? `
            <img src="${internship.imgurl}" class="card-img-top internship-img" alt="${internship.company_name}">
          ` : ''}
          <div class="card-body">
            <h5 class="card-title">${internship.company_name}</h5>
            <h6 class="card-subtitle mb-2 text-muted">${internship.position}</h6>
            <p class="card-text">
              ${internship.description || 'No description available'}
            </p>
            <p class="card-text">
              <small class="text-muted">Duration: ${internship.duration}</small><br>
              <small class="text-muted">
                ${new Date(internship.start_date).toLocaleDateString()} - 
                ${new Date(internship.end_date).toLocaleDateString()}
              </small><br>
              ${internship.application_fee !== null && !isNaN(internship.application_fee) ? `
                <small class="text-muted">Amount: ‚Çπ${internship.application_fee} (Application Fee)</small>
              ` : ''}
            </p>
            <span class="badge rounded-pill ${getStatusClass(internship.status)}">
              ${internship.status}
            </span>
            ${hasApplied ? `
              <span class="badge rounded-pill bg-info mt-2">
                ${isPaid ? 'Payment Completed' : 'Application Submitted'}
              </span>
            ` : ''}
          </div>
          <div class="card-footer bg-transparent">
            ${internship.status === 'active' ? `
              <button class="btn btn-primary w-100" 
                onclick="${hasApplied ? '' : `startApplication(${internship.id})`}"
                ${hasApplied ? 'disabled' : ''}>
                <i class="fas fa-paper-plane"></i> 
                ${hasApplied ? 'Already Applied' : 'Apply Now'}
              </button>
            ` : `
              <button class="btn btn-secondary w-100" disabled>
                <i class="fas fa-ban"></i> Applications ${internship.status === 'completed' ? 'Closed' : 'Not Available'}
              </button>
            `}
          </div>
        </div>
      </div>
    `;
  }).join('');
}
   async function startApplication(internshipId) {
  currentInternshipId = internshipId;
  
  try {
    // First check if already applied
    const checkRes = await fetch(`${BASE}/api/internships/applied`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    
    if (checkRes.ok) {
      const applications = await checkRes.json();
      const existingApplication = applications.find(app => app.internship_id === currentInternshipId);
      
      if (existingApplication) {
        if (existingApplication.transaction_id) {
          // Already applied and paid
          await Swal.fire({
            title: 'Already Applied',
            text: 'You have already applied and paid for this internship',
            icon: 'info'
          });
          return;
        } else {
          // Already applied but not paid - open modal directly to payment step
          currentApplicationId = existingApplication.id;
          resetApplicationModal();
          showPaymentStep();
          applicationModal.show();
          return;
        }
      }
    }
    
    // If not applied yet, open modal normally (confirmation first)
    resetApplicationModal();
    applicationModal.show();
    
  } catch (err) {
    console.error('Error checking applications:', err);
    // If error checking, proceed normally
    resetApplicationModal();
    applicationModal.show();
  }
}

// Modify confirmApplication to just proceed to payment (no checks needed)
async function confirmApplication() {
  showPaymentStep();
}

function resetApplicationModal() {
  // Hide all steps
  document.querySelectorAll('.application-flow').forEach(step => {
    step.classList.remove('active-flow');
  });
  // Show first step
  document.getElementById('confirmStep').classList.add('active-flow');
  document.getElementById('applicationModalTitle').textContent = 'Apply for Internship';
}



async function showPaymentStep() {
  try {
    // Get internship details for payment QR
    const res = await fetch(`${BASE}/api/internships/${currentInternshipId}`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    
    if (!res.ok) throw new Error('Failed to load internship details');
    const internship = await res.json();
    
    // Update modal title
    document.getElementById('applicationModalTitle').textContent = 'Complete Your Payment';
    
    // Populate payment content
    document.getElementById('paymentContent').innerHTML = `
      <div class="mb-3">
        <h5>${internship.position} at ${internship.company_name}</h5>
        <p class="text-muted">Please complete payment to finalize your application</p>
      </div>
      
      <div class="payment-instructions">
        <h6><i class="fas fa-info-circle me-2"></i>Payment Instructions:</h6>
        <ol>
          <li>Scan the QR code below using your payment app</li>
          <li>Complete the payment</li>
          <li>Enter the transaction ID/reference number below</li>
          <li>Click "Submit Payment"</li>
        </ol>
      </div>
      
      ${internship.payment_qr ? `
        <div class="text-center mb-4">
          <p class="mb-2"><strong>Scan to Pay:</strong></p>
          <img src="${internship.payment_qr}" class="img-fluid qr-img border p-2 mb-2">
          <p class="small text-muted">Amount: ‚Çπ${internship.application_fee} (Application Fee)</p>
        </div>
      ` : `
        <div class="alert alert-warning">
          No payment QR code available for this internship
        </div>
      `}
      
      <div class="mb-3">
        <label for="transactionNo" class="form-label">Transaction ID/Reference Number</label>
        <input type="text" class="form-control" id="transactionNo" 
              placeholder="Enter transaction ID from your payment receipt" required>
        <div class="form-text">This is required to verify your payment</div>
      </div>

      <div class="mb-3">
        <label for="referralCode" class="form-label">Referral Code (Optional)</label>
        <input type="text" class="form-control" id="referralCode" 
              placeholder="Enter referral code if you have one">
        <div class="form-text">Leave empty if you don't have a referral code</div>
      </div>
    `;
    
    // Switch to payment step
    document.getElementById('confirmStep').classList.remove('active-flow');
    document.getElementById('paymentStep').classList.add('active-flow');
  } catch (err) {
    applicationModal.hide();
    Swal.fire('Error', err.message, 'error');
  }
}

async function submitPayment() {
  try {
    const transactionNo = document.getElementById('transactionNo').value.trim();
    const referralCode = document.getElementById('referralCode')?.value?.trim() || null;

    if (!transactionNo) {
      throw new Error('Please enter your transaction ID/reference number');
    }

    // Show loading state
    const submitBtn = document.querySelector('#paymentStep .btn-success');
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
    submitBtn.disabled = true;

    // First create the application
    const applyRes = await fetch(`${BASE}/api/internships/${currentInternshipId}/apply`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      }
    });

    if (!applyRes.ok) {
      const error = await applyRes.json();
      throw new Error(error.message || 'Failed to apply');
    }

    const applyResult = await applyRes.json();
    currentApplicationId = applyResult.applicationId;

    // Then submit payment with the transaction details
    const paymentRes = await fetch(`${BASE}/api/internships/${currentInternshipId}/submit-payment`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ 
        transactionNo,
        referralCode
      })
    });

    if (!paymentRes.ok) {
      const error = await paymentRes.json();
      throw new Error(error.message || 'Payment submission failed');
    }

    // Show success step
    document.getElementById('paymentStep').classList.remove('active-flow');
    document.getElementById('successStep').classList.add('active-flow');
    document.getElementById('applicationModalTitle').textContent = 'Application Complete';
    
  } catch (err) {
    // Reset button state
    const submitBtn = document.querySelector('#paymentStep .btn-success');
    submitBtn.innerHTML = 'Submit Payment';
    submitBtn.disabled = false;
    
    Swal.fire('Error', err.message, 'error');
  }
}

    async function loadMyApplications() {
      try {
        document.getElementById('applicationsModalBody').innerHTML = `
          <div class="text-center my-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading your applications...</p>
          </div>
        `;
        
        applicationsModal.show();
        
        const res = await fetch(`${BASE}/api/internships/applied`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (!res.ok) throw new Error('Failed to load your applications');
        
        const applications = await res.json();
        renderMyApplications(applications);
      } catch (err) {
        document.getElementById('applicationsModalBody').innerHTML = `
          <div class="alert alert-danger">
            Error loading your applications: ${err.message}
          </div>
        `;
      }
    }

function renderMyApplications(applications) {
  console.log("üì¶ All Applications:", applications); // üîç Logs everything

  const container = document.getElementById('applicationsModalBody');
  
  if (applications.length === 0) {
    container.innerHTML = `
      <div class="alert alert-info">
        You haven't applied to any internships yet
      </div>
    `;
    return;
  }
  
  container.innerHTML = `
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Company</th>
            <th>Position</th>
            <th>Status</th>
            <th>Applied At</th>
          </tr>
        </thead>
        <tbody>
          ${applications.map(app => {
            console.log("üìù Application:", app); // üîç Individual log
            return `
              <tr>
                <td>${app.company_name}</td>
                <td>${app.position}</td>
                <td>
                  <span class="badge ${app.status === 'approved' ? 'bg-success' : 
                                      app.status === 'rejected' ? 'bg-danger' : 'bg-secondary'}">
                    ${app.status}
                  </span>
                </td>
                <td>
  ${new Date(app.submitted_at).toLocaleString('en-IN', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  })}
</td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function toggleNavMenu() {
    const navMenu = document.getElementById('navMenu');
    navMenu.style.left = navMenu.style.left === '0px' ? '-100%' : '0px';
  }

  function handleResize() {
    const hamburger = document.getElementById('hamburgerBtn');
    const navMenu = document.getElementById('navMenu');
    if (window.innerWidth <= 768) {
      hamburger.style.display = 'flex';
      navMenu.style.position = 'fixed';
      navMenu.style.left = '-100%';
      navMenu.style.top = '70px';
      navMenu.style.width = '100%';
      navMenu.style.background = 'white';
      navMenu.style.flexDirection = 'column';
      navMenu.style.textAlign = 'center';
      navMenu.style.padding = '2rem 0';
      navMenu.style.transition = 'left 0.3s ease';
      navMenu.style.boxShadow = '0 10px 27px rgba(0, 0, 0, 0.05)';
    } else {
      hamburger.style.display = 'none';
      navMenu.removeAttribute('style');
      navMenu.style.display = 'flex';
      navMenu.style.gap = '2rem';
      navMenu.style.listStyle = 'none';
      navMenu.style.alignItems = 'center';
    }
  }

  function logoutUser() {
    localStorage.clear(); // Clear all localStorage keys
    window.location.href = "Login.html";
  }

  document.addEventListener("DOMContentLoaded", () => {
    const user = localStorage.getItem("user");
    if (user) {
      document.getElementById("logoutItem").style.display = "block";
      document.getElementById("loginItem").style.display = "none";
    } else {
      document.getElementById("logoutItem").style.display = "none";
      document.getElementById("loginItem").style.display = "block";
    }
    handleResize();
  });

  window.addEventListener('resize', handleResize);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
</body>
</html>
